# Docker Setup Guide

This guide explains how to use the Docker setup for this project, which uses Astral's `uv` for fast Python dependency management.

## Prerequisites

- Docker and Docker Compose installed
- `uv.lock` file present in the project root (generated by `uv`)

## Environment Setup

1. Copy the example environment file:
   ```bash
   cp .env.example .env
   ```

2. Edit `.env` with your configuration:
   - `BUILD_MODE`: Set to `dev` for development or `prod` for production
   - `COMPOSE_PROJECT_NAME`: Your project name (default: my-stack)
   - `APP_PORT`: Port for the application (default: 8000)
   - `BASE_DOMAIN`: Domain for Traefik routing (default: localhost)

## Development Mode

To run the application in development mode with hot reload:

```bash
cd docker
BUILD_MODE=dev docker-compose up --build
```

Or run in detached mode:
```bash
cd docker
BUILD_MODE=dev docker-compose up --build -d
```

The development container includes:
- All development dependencies
- Hot reload enabled
- Source code mounted for live updates
- Debugging tools

Access the application at:
- Direct: http://localhost:8000
- Through Traefik: http://app.localhost

## Production Mode

To run the application in production mode:

```bash
cd docker
BUILD_MODE=prod docker-compose up --build
```

Or run in detached mode:
```bash
cd docker
BUILD_MODE=prod docker-compose up --build -d
```

The production container is optimized for:
- Minimal image size
- Production dependencies only
- Security best practices
- Performance

## Dockerfile Architecture

### Development Dockerfile (`docker/app/Dockerfile.dev`)
- Multi-stage build using `uv` for fast dependency installation
- Includes all development dependencies
- Runs with hot reload
- Optimized for development workflow

### Production Dockerfile (`docker/app/Dockerfile.prod`)
- Multi-stage build for minimal final image
- Only production dependencies installed
- Health checks included
- Security-optimized configuration

## Key Features

1. **Fast Builds**: Uses `uv` for faster dependency installation
2. **Caching**: Leverages Docker layer caching and `uv` cache mounts
3. **Security**: Runs as non-root user
4. **Health Checks**: Built-in health monitoring
5. **Environment Separation**: Clear distinction between dev and prod

## Common Commands

### View Logs
```bash
cd docker
BUILD_MODE=dev docker-compose logs -f app
```

### Stop Services
```bash
cd docker
docker-compose down
```

### Rebuild Without Cache
```bash
cd docker
BUILD_MODE=dev docker-compose build --no-cache
```

### Access Container Shell
```bash
cd docker
BUILD_MODE=dev docker-compose exec app bash
```

## Troubleshooting

### Permission Issues
If you encounter permission issues, ensure:
- Your user has Docker permissions
- The `.env` file is correctly configured

### Build Failures
- Check that `uv.lock` exists in the project root
- Ensure all required files are present
- Try rebuilding with `--no-cache` flag

### Port Conflicts
- Change `APP_PORT` in your `.env` file
- Ensure no other services are using the same ports

## Architecture Notes

This setup uses:
- **Astral's uv**: Fast Python package installer
- **Multi-stage builds**: Optimized for both development and production
- **Traefik**: For reverse proxy and load balancing
- **Non-root execution**: For enhanced security